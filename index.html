<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain File Integrity</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Web3.js for MetaMask -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .app-container {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 1200px;
            width: 100%;
            overflow: hidden; /* Ensure content doesn't spill out of rounded corners */
        }
        .nav-bar {
            background-color: #4f46e5;
            display: flex;
            justify-content: space-around;
            padding: 0.75rem 0;
            border-bottom: 1px solid #4338ca;
        }
        .nav-button {
            flex: 1;
            text-align: center;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            color: #e0e7ff;
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer;
            border-radius: 0.5rem;
            margin: 0 0.5rem;
        }
        .nav-button:hover:not(.bg-indigo-700) {
            background-color: #6366f1;
        }
        .nav-button.bg-indigo-700 {
            background-color: #3730a3;
            color: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .pane-content {
            padding: 2rem;
        }
        .panel {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .status-message {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: 500;
        }
        .status-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-info {
            background-color: #e0f2fe;
            color: #0369a1;
        }
        .button-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
        }
        .button-primary:hover {
            background-color: #4338ca;
        }
        .button-primary:disabled {
            background-color: #a78bfa;
            cursor: not-allowed;
        }
        .input-file {
            display: block;
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .ledger-entry {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .ledger-entry:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }
        .ledger-display-container {
            background-color: #f9fafb;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-height: 60vh; /* Limit height for scrollability */
            overflow-y: auto;
            border: 1px solid #e5e7eb;
        }
        .tamper-instructions ol {
            list-style-type: decimal;
            margin-left: 1.5rem;
        }
        .tamper-instructions li {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="nav-bar">
            <button class="nav-button" data-pane="upload-pane">Upload File</button>
            <button class="nav-button" data-pane="verify-pane">Verify File</button>
            <button class="nav-button" data-pane="audit-pane">Audit Trail</button>
            <button class="nav-button" data-pane="tamper-demo-pane">Tamper Demo</button>
        </div>

        <div class="pane-content" id="connect-wallet-pane">
            <div class="panel text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Connect Your Wallet</h2>
                <p class="text-gray-600 mb-6">Please connect your MetaMask wallet to use the application.</p>
                <button id="connectMetaMaskButton" class="button-primary flex items-center justify-center mx-auto">
                    Connect MetaMask
                    <span id="metaMaskSpinner" class="loading-spinner hidden"></span>
                </button>
                <div id="metaMaskStatus" class="status-message hidden mx-auto max-w-md"></div>
                <p id="connectedAccountDisplay" class="mt-4 text-gray-700 font-medium hidden">Connected Account: <span class="font-mono text-sm" id="accountAddress"></span></p>
            </div>
        </div>

        <!-- Upload Pane -->
        <div class="pane-content hidden" id="upload-pane">
            <div class="panel">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Secure File Upload</h2>
                <p class="text-gray-600 mb-4">Upload a file to generate its hash and log it onto our simulated blockchain ledger via Supabase.</p>

                <div class="mb-4">
                    <label for="uploadFile" class="block text-gray-700 text-sm font-semibold mb-2">Select File:</label>
                    <input type="file" id="uploadFile" class="input-file">
                </div>

                <button id="uploadButton" class="button-primary w-full flex items-center justify-center">
                    Upload File
                    <span id="uploadSpinner" class="loading-spinner hidden"></span>
                </button>

                <div id="uploadStatus" class="status-message hidden"></div>
                <div id="fileHashDisplay" class="mt-4 p-3 bg-gray-50 rounded-lg text-sm break-words hidden">
                    <p class="font-semibold text-gray-700">Generated Hash:</p>
                    <p id="currentFileHash" class="text-gray-900"></p>
                </div>
            </div>
        </div>

        <!-- Verify Pane -->
        <div class="pane-content hidden" id="verify-pane">
            <div class="panel">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Verify File Integrity</h2>
                <p class="text-gray-600 mb-4">Select a file to verify its integrity against the logged hashes in the Supabase ledger.</p>

                <div class="mb-4">
                    <label for="verifyFile" class="block text-gray-700 text-sm font-semibold mb-2">Select File for Verification:</label>
                    <input type="file" id="verifyFile" class="input-file">
                </div>

                <button id="verifyButton" class="button-primary w-full flex items-center justify-center">
                    Verify File
                    <span id="verifySpinner" class="loading-spinner hidden"></span>
                </button>

                <div id="verifyStatus" class="status-message hidden"></div>
            </div>
        </div>

        <!-- Audit Trail Pane -->
        <div class="pane-content hidden" id="audit-pane">
            <div class="panel">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Audit Trail (Blockchain Ledger)</h2>
                <p class="text-gray-600 mb-4">View the immutable ledger of file uploads. Any tampering will be highlighted.</p>

                <div class="ledger-display-container">
                    <p class="text-gray-500 text-center" id="noEntriesMessage">No entries yet. Upload a file to get started!</p>
                    <div id="ledgerDisplay">
                        <!-- Ledger entries will be dynamically loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tamper Demo Pane -->
        <div class="pane-content hidden" id="tamper-demo-pane">
            <div class="panel">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Tamper Demonstration</h2>
                <p class="text-gray-600 mb-4">This section explains how to demonstrate the tamper-proof nature of the system.</p>

                <div class="tamper-instructions text-gray-700">
                    <h3 class="text-xl font-semibold mb-3">How to Demonstrate File Tampering:</h3>
                    <ol class="list-decimal pl-5 mb-6">
                        <li>Go to the "Upload File" pane.</li>
                        <li>Select any text file (e.g., `my_document.txt`) and click "Upload File".</li>
                        <li>Observe the file hash generated and the new block added to the "Audit Trail".</li>
                        <li>Now, **open the original `my_document.txt` file on your computer and make a small change** (e.g., add a space, change a letter). Save the file.</li>
                        <li>Go to the "Verify File" pane.</li>
                        <li>Select the **modified** `my_document.txt` file and click "Verify File".</li>
                        <li>The verification will fail, indicating "No matching entry found..." because the hash of the modified file no longer matches the original hash recorded in the ledger.</li>
                    </ol>

                    <h3 class="text-xl font-semibold mb-3">How to Demonstrate Ledger Tampering (Conceptual):</h3>
                    <p class="mb-4">
                        While direct modification of the Supabase database is not exposed in this UI, conceptually, if someone were to manually alter a `file_hash` or `previous_block_content_hash` directly in your Supabase table:
                    </p>
                    <ol class="list-decimal pl-5">
                        <li>If you were to manually change a `file_hash` or `previous_block_content_hash` for an *earlier* block in the `blockchain_ledger` table in your Supabase console.</li>
                        <li>When you revisit the "Audit Trail" pane, the system would re-verify the chain.</li>
                        <li>You would see a prominent "Chain integrity compromised" warning, and the affected blocks would be highlighted in red, demonstrating that the cryptographic link has been broken.</li>
                    </ol>
                    <p class="mt-4 text-sm text-gray-500">
                        This highlights how the `previous_block_content_hash` ensures that even a single alteration in the history makes the entire subsequent chain invalid.
                    </p>
                </div>
            </div>
        </div>

    </div>

    <!-- Supabase SDK -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Supabase Configuration (REPLACE WITH YOURS) ---
        const SUPABASE_URL = 'https://vxjrofoirudzuhnbximw.supabase.co'; // e.g., 'https://abcde12345.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4anJvZm9pcnVkenVobmJ4aW13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MjMxNjMsImV4cCI6MjA2ODk5OTE2M30.iJJVjlmpY13OUZouE8Rl9QVVTtvnNKaeK2nKBCwI1Z4'; // e.g., 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Global Variables ---
        let web3; // Web3.js instance
        let connectedAccount = null; // Connected MetaMask account address
        let isAuthReady = false; // Flag to indicate if MetaMask is connected

        // --- DOM Elements ---
        const connectMetaMaskButton = document.getElementById('connectMetaMaskButton');
        const metaMaskStatus = document.getElementById('metaMaskStatus');
        const metaMaskSpinner = document.getElementById('metaMaskSpinner');
        const connectedAccountDisplay = document.getElementById('connectedAccountDisplay');
        const accountAddressSpan = document.getElementById('accountAddress');

        const navButtons = document.querySelectorAll('.nav-button');
        const paneContents = document.querySelectorAll('.pane-content');
        const connectWalletPane = document.getElementById('connect-wallet-pane');

        const uploadFile = document.getElementById('uploadFile');
        const uploadButton = document.getElementById('uploadButton');
        const uploadStatus = document.getElementById('uploadStatus');
        const fileHashDisplay = document.getElementById('fileHashDisplay');
        const currentFileHashElem = document.getElementById('currentFileHash');
        const uploadSpinner = document.getElementById('uploadSpinner');

        const ledgerDisplay = document.getElementById('ledgerDisplay');
        const noEntriesMessage = document.getElementById('noEntriesMessage');

        const verifyFile = document.getElementById('verifyFile');
        const verifyButton = document.getElementById('verifyButton');
        const verifyStatus = document.getElementById('verifyStatus');
        const verifySpinner = document.getElementById('verifySpinner');

        // --- Utility Functions ---
        function setStatus(element, message, type) {
            element.textContent = message;
            element.className = `status-message ${type}`;
            element.classList.remove('hidden');
        }

        function clearStatus(element) {
            element.classList.add('hidden');
            element.textContent = '';
        }

        function showSpinner(spinnerElement, buttonElement) {
            spinnerElement.classList.remove('hidden');
            buttonElement.disabled = true;
        }

        function hideSpinner(spinnerElement, buttonElement) {
            spinnerElement.classList.add('hidden');
            buttonElement.disabled = false;
        }

        // --- Pane Switching Logic ---
        function showPane(paneId) {
            paneContents.forEach(pane => {
                pane.classList.add('hidden');
            });
            document.getElementById(paneId).classList.remove('hidden');

            navButtons.forEach(button => {
                button.classList.remove('bg-indigo-700', 'text-white');
                button.classList.add('text-indigo-200', 'hover:bg-indigo-600');
            });
            const activeButton = document.querySelector(`button[data-pane="${paneId}"]`);
            if (activeButton) {
                activeButton.classList.add('bg-indigo-700', 'text-white');
                activeButton.classList.remove('text-indigo-200', 'hover:bg-indigo-600');
            }
        }

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (!isAuthReady) {
                    setStatus(metaMaskStatus, "Please connect your MetaMask wallet first.", 'status-info');
                    showPane('connect-wallet-pane');
                    return;
                }
                showPane(button.dataset.pane);
            });
        });

        // --- MetaMask Connection ---
        connectMetaMaskButton.addEventListener('click', async () => {
            showSpinner(metaMaskSpinner, connectMetaMaskButton);
            clearStatus(metaMaskStatus);

            if (window.ethereum) {
                try {
                    // Request account access
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    web3 = new Web3(window.ethereum);
                    connectedAccount = accounts[0];
                    accountAddressSpan.textContent = connectedAccount;
                    connectedAccountDisplay.classList.remove('hidden');
                    isAuthReady = true;
                    setStatus(metaMaskStatus, `Connected: ${connectedAccount.substring(0, 6)}...${connectedAccount.slice(-4)}`, 'status-success');
                    console.log("MetaMask connected. Account:", connectedAccount);

                    // Listen for account changes
                    window.ethereum.on('accountsChanged', (newAccounts) => {
                        if (newAccounts.length > 0) {
                            connectedAccount = newAccounts[0];
                            accountAddressSpan.textContent = connectedAccount;
                            setStatus(metaMaskStatus, `Account changed to: ${connectedAccount.substring(0, 6)}...${connectedAccount.slice(-4)}`, 'status-info');
                            console.log("MetaMask account changed:", connectedAccount);
                            // Re-fetch ledger if needed, or just update UI
                            fetchAndRenderLedger();
                        } else {
                            connectedAccount = null;
                            isAuthReady = false;
                            setStatus(metaMaskStatus, "MetaMask disconnected. Please connect again.", 'status-error');
                            connectedAccountDisplay.classList.add('hidden');
                            console.log("MetaMask disconnected.");
                            showPane('connect-wallet-pane'); // Go back to connect pane
                        }
                    });

                    // Listen for chain changes (network changes)
                    window.ethereum.on('chainChanged', (chainId) => {
                        console.log("Network changed to:", chainId);
                        setStatus(metaMaskStatus, `Network changed. Please ensure you are on the correct network.`, 'status-info');
                        // You might want to reload the page or re-initialize Web3 here
                    });

                    // Automatically show the upload pane after successful connection
                    showPane('upload-pane');
                    fetchAndRenderLedger(); // Initial fetch of ledger
                } catch (error) {
                    console.error("MetaMask connection failed:", error);
                    setStatus(metaMaskStatus, `MetaMask connection failed: ${error.message}`, 'status-error');
                    isAuthReady = false;
                }
            } else {
                setStatus(metaMaskStatus, "MetaMask is not installed. Please install it to use this application.", 'status-error');
                isAuthReady = false;
            }
            hideSpinner(metaMaskSpinner, connectMetaMaskButton);
        });

        // --- Hashing Function ---
        async function sha256(file) {
            const buffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hexHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hexHash;
        }

        // --- Utility to calculate content hash for chaining ---
        async function calculateBlockContentHash(blockData) {
            // Ensure timestamp is in ISO string format for consistent hashing
            const timestampForHash = blockData.timestamp instanceof Date
                ? blockData.timestamp.toISOString()
                : blockData.timestamp; // If already a string (from Supabase)

            const dataToHash = {
                fileHash: blockData.file_hash, // Use Supabase column names
                fileName: blockData.file_name,
                timestamp: timestampForHash,
                blockNumber: blockData.block_number
            };
            const jsonString = JSON.stringify(dataToHash);
            const encoder = new TextEncoder();
            const data = encoder.encode(jsonString);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- File Upload Logic ---
        uploadButton.addEventListener('click', async () => {
            if (!isAuthReady || !connectedAccount) {
                setStatus(uploadStatus, "Please connect your MetaMask wallet first.", 'status-info');
                showPane('connect-wallet-pane');
                return;
            }
            const file = uploadFile.files[0];
            if (!file) {
                setStatus(uploadStatus, "Please select a file to upload.", 'status-error');
                return;
            }

            showSpinner(uploadSpinner, uploadButton);
            clearStatus(uploadStatus);
            fileHashDisplay.classList.add('hidden');

            try {
                setStatus(uploadStatus, "Calculating file hash...", 'status-info');
                const fileHash = await sha256(file);
                currentFileHashElem.textContent = fileHash;
                fileHashDisplay.classList.remove('hidden');

                setStatus(uploadStatus, "Fetching last block from Supabase...", 'status-info');
                const { data: lastBlocks, error: lastBlockError } = await supabase
                    .from('blockchain_ledger')
                    .select('*')
                    .order('block_number', { ascending: false })
                    .limit(1);

                if (lastBlockError) throw lastBlockError;

                let lastBlock = null;
                let previousBlockContentHash = "0"; // Genesis block hash
                let nextBlockNumber = 1;

                if (lastBlocks && lastBlocks.length > 0) {
                    lastBlock = lastBlocks[0];
                    // Calculate hash of the last block's content for chaining
                    previousBlockContentHash = await calculateBlockContentHash(lastBlock);
                    nextBlockNumber = lastBlock.block_number + 1;
                }

                setStatus(uploadStatus, "Adding block to ledger via Supabase...", 'status-info');
                const newBlock = {
                    file_hash: fileHash,
                    file_name: file.name,
                    // timestamp will be set by Supabase default `now()`
                    previous_block_content_hash: previousBlockContentHash,
                    block_number: nextBlockNumber,
                    user_id: connectedAccount // Use connected MetaMask account as user ID
                };

                const { error: insertError } = await supabase
                    .from('blockchain_ledger')
                    .insert([newBlock]);

                if (insertError) throw insertError;

                setStatus(uploadStatus, `File "${file.name}" uploaded and logged successfully! Block #${nextBlockNumber}`, 'status-success');
                uploadFile.value = ''; // Clear file input
                fetchAndRenderLedger(); // Refresh ledger display
            } catch (error) {
                console.error("Error during file upload:", error);
                setStatus(uploadStatus, `Error uploading file: ${error.message}`, 'status-error');
            } finally {
                hideSpinner(uploadSpinner, uploadButton);
            }
        });

        // --- Ledger Display Logic (Real-time updates & Initial Fetch) ---
        async function fetchAndRenderLedger() {
            if (!connectedAccount) {
                ledgerDisplay.innerHTML = `<p class="text-gray-500 text-center">Please connect your MetaMask wallet to view the ledger.</p>`;
                noEntriesMessage.classList.add('hidden'); // Hide default message
                return;
            }

            const { data: blocks, error } = await supabase
                .from('blockchain_ledger')
                .select('*')
                .order('block_number', { ascending: true });

            if (error) {
                console.error("Error fetching ledger:", error);
                ledgerDisplay.innerHTML = `<p class="text-red-600 text-center">Error loading ledger: ${error.message}</p>`;
                noEntriesMessage.classList.add('hidden');
                return;
            }

            ledgerDisplay.innerHTML = ''; // Clear previous entries
            if (blocks.length === 0) {
                noEntriesMessage.classList.remove('hidden');
                return;
            } else {
                noEntriesMessage.classList.add('hidden');
            }

            let isChainValid = true;
            let previousBlockData = null; // To store data of the previous block for chaining check

            for (let i = 0; i < blocks.length; i++) {
                const block = blocks[i];

                // Convert Supabase timestamp string to Date object for consistent display
                const timestampStr = new Date(block.timestamp).toLocaleString();

                let blockValidityClass = 'text-gray-800'; // Default valid
                let chainIntegrityMessage = '';

                // Chain integrity check (skip for the first block)
                if (i > 0 && previousBlockData) {
                    const expectedPreviousHash = await calculateBlockContentHash(previousBlockData);
                    if (block.previous_block_content_hash !== expectedPreviousHash) {
                        isChainValid = false;
                        blockValidityClass = 'bg-red-100 text-red-800'; // Indicate broken chain
                        chainIntegrityMessage = '<p class="text-red-600 text-xs mt-1">ðŸš¨ Chain integrity compromised from this block!</p>';
                    }
                }

                const entryDiv = document.createElement('div');
                entryDiv.className = `ledger-entry p-4 rounded-lg shadow-sm mb-4 ${blockValidityClass}`;
                entryDiv.innerHTML = `
                    <p class="font-bold text-lg">Block #${block.block_number}</p>
                    <p class="text-sm text-gray-600"><strong>File Name:</strong> ${block.file_name}</p>
                    <p class="text-sm text-gray-600 break-words"><strong>File Hash:</strong> <span class="font-mono text-xs">${block.file_hash}</span></p>
                    <p class="text-sm text-gray-600 break-words"><strong>Prev. Block Hash:</strong> <span class="font-mono text-xs">${block.previous_block_content_hash}</span></p>
                    <p class="text-sm text-gray-600"><strong>Timestamp:</strong> ${timestampStr}</p>
                    <p class="text-sm text-gray-600"><strong>Logged by User:</strong> ${block.user_id ? block.user_id.substring(0, 8) + '...' : 'N/A'}</p>
                    ${chainIntegrityMessage}
                `;
                ledgerDisplay.appendChild(entryDiv);

                previousBlockData = block; // Store current block's data for the next iteration's check
            }

            if (!isChainValid) {
                setStatus(verifyStatus, "Warning: The blockchain ledger's integrity is compromised! Some blocks might have been tampered with.", 'status-error');
            } else {
                clearStatus(verifyStatus); // Clear any previous chain integrity warning
            }
        }

        // Setup Supabase real-time listener
        function setupSupabaseRealtime() {
            supabase
                .channel('public:blockchain_ledger')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'blockchain_ledger' }, payload => {
                    console.log('Change received!', payload);
                    // Re-fetch and render the entire ledger on any change for simplicity
                    fetchAndRenderLedger();
                })
                .subscribe();
        }

        // --- File Verification Logic ---
        verifyButton.addEventListener('click', async () => {
            if (!isAuthReady || !connectedAccount) {
                setStatus(verifyStatus, "Please connect your MetaMask wallet first.", 'status-info');
                showPane('connect-wallet-pane');
                return;
            }
            const file = verifyFile.files[0];
            if (!file) {
                setStatus(verifyStatus, "Please select a file to verify.", 'status-error');
                return;
            }

            showSpinner(verifySpinner, verifyButton);
            clearStatus(verifyStatus);

            try {
                setStatus(verifyStatus, "Calculating file hash for verification...", 'status-info');
                const verificationFileHash = await sha256(file);

                setStatus(verifyStatus, "Retrieving ledger for verification...", 'status-info');
                const { data: blocks, error } = await supabase
                    .from('blockchain_ledger')
                    .select('*')
                    .order('block_number', { ascending: true });

                if (error) throw error;

                if (blocks.length === 0) {
                    setStatus(verifyStatus, "Ledger is empty. No files to verify against.", 'status-error');
                    return;
                }

                let foundMatch = false;
                let isChainIntact = true;
                let previousBlockData = null;

                for (const block of blocks) {
                    // Check chain integrity
                    if (previousBlockData) {
                        const expectedPreviousHash = await calculateBlockContentHash(previousBlockData);
                        if (block.previous_block_content_hash !== expectedPreviousHash) {
                            isChainIntact = false;
                            setStatus(verifyStatus, `Verification failed: Blockchain integrity compromised at Block #${block.block_number}.`, 'status-error');
                            break; // Stop verification if chain is broken
                        }
                    }

                    // Check if the file hash matches any block in the ledger
                    if (block.file_hash === verificationFileHash && block.file_name === file.name) {
                        foundMatch = true;
                        setStatus(verifyStatus, `File "${file.name}" verified successfully! Match found in Block #${block.block_number}. Ledger is intact.`, 'status-success');
                        break; // Found a match and chain is intact up to this point
                    }
                    previousBlockData = block;
                }

                if (isChainIntact && !foundMatch) {
                    setStatus(verifyStatus, `Verification failed: No matching entry found for "${file.name}" in the ledger with the calculated hash.`, 'status-error');
                } else if (!isChainIntact) {
                    // Status already set by the chain integrity check
                }

            } catch (error) {
                console.error("Error during file verification:", error);
                setStatus(verifyStatus, `Error verifying file: ${error.message}`, 'status-error');
            } finally {
                hideSpinner(verifySpinner, verifyButton);
            }
        });

        // --- Initial Setup ---
        window.onload = () => {
            showPane('connect-wallet-pane'); // Start on the connect wallet pane
            setupSupabaseRealtime(); // Setup real-time listener for ledger updates
        };
    </script>
</body>
</html>
